<!DOCTYPE html>
<html>
<head>
    <title>API Key Management</title>
    <link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; }
        .gear { cursor: pointer; color: green; }
        .gear-yellow { color: gold; cursor: pointer; }
        #configPopup {
            position: absolute;
            border: 1px solid #ccc;
            background: #eee;
            padding: 15px;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div><strong>User:</strong> <span id="userId"></span></div>
    <div><strong>WebSocket:</strong> <span id="wsStatus" style="color: orange;">connecting...</span></div>
    <form id="apiForm">
        <label>API Key:</label><br><input type="text" id="apiKey" required><br><br>
        <label>API Secret:</label><br><input type="text" id="apiSecret" required><br><br>
        <button type="submit">Save</button>
    </form>
    <br>
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="logout()">Logout</button>
    <button onclick="deleteKeys()">Delete Keys</button>

    <div id="defaultConfig">
        <h3>Default Config <span class="gear" onclick="toggleDefaultConfig()">[Settings]</span></h3>
    </div>

    <div id="positions-table" style="margin: 15px 0;"></div>
    <div><h3>WebSocket Log:</h3><pre id="wsLog" style="background:#222;color:#eee;padding:10px;max-height:300px;overflow:auto;"></pre></div>

    <div id="configPopup">
        <form id="configEditForm" onsubmit="event.preventDefault(); saveConfig();">
            <label>Strategy on Stop Loss:</label><br>
            <select id="cfgStrategy">
                <option value="close">Close</option>
                <option value="reverse">Reverse</option>
            </select><br>
            <label>Stop Loss Range:</label><br>
            <input type="number" step="0.01" id="cfgStopLoss"><br>
            <label>Strategy on Trailing Stop:</label><br>
            <select id="cfgReverse">
                <option value="close">Close</option>
                <option value="reverse">Reverse</option>
            </select><br>
            <label>Trailing Stop Range:</label><br>
            <input type="number" step="0.01" id="cfgTrailingStop"><br><br>
            <input type="hidden" id="cfgSymbol">
            <button type="submit">Save</button>
            <button type="button" onclick="closeConfig()">Cancel</button>
        </form>
    </div>

    <script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script>
    const token = new URLSearchParams(window.location.search).get("token");
    if (token) localStorage.setItem("jwt", token);
    const jwt = localStorage.getItem("jwt");
    let decoded = null, ws, userId = null;
    let positionsData = [], positionsMap = {}, tabulatorTable = null;

    if (jwt) {
        decoded = jwt_decode(jwt);
        userId = decoded.email || decoded.sub || decoded.id || "";
        document.getElementById("userId").innerText = userId;

        fetch("/api-keys", {headers:{"Authorization":"Bearer "+jwt}})
            .then(res=>res.json())
            .then(data=>{
                document.getElementById("apiKey").value=data.api_key||"";
                document.getElementById("apiSecret").value=data.secret_key||"";
            }).catch(()=>{});

        connectWebSocket(); loadDefaultConfig(); initTabulator();
    }

    function initTabulator(){
        tabulatorTable = new Tabulator("#positions-table", {
            height: "250px",
            layout: "fitColumns",
            placeholder: "Íåò îòêðûòûõ ïîçèöèé",
            theme: "midnight",
            index: "key",
            columns: [
                { title: "Symbol", field: "symbol" },
                {
                  title: "Side", field: "position_side", headerSort: false,
                  formatter: function(cell){
                    let val = cell.getValue();
                    let color = val === "LONG" ? "#1976d2" : "#c62828";
                    return `<span style="color:${color};font-weight:bold">${val}</span>`;
                  }
                },
                {
                  title: "PnL", field: "calculated_pnl", headerSort: false,
                  formatter: function(cell){
                    let val = cell.getValue();
                    let color = val >= 0 ? "limegreen" : "tomato";
                    return `<span style="color:${color};font-weight:bold">${val.toFixed(2)}</span>`;
                  }
                },
                { title: "TS", field: "max_trailing_stop" },
                { title: "Latest Price", field: "latest_price" },
                {
                    title: "Settings",
                    formatter: () => '<span class="gear">[Settings]</span>',
                    cellClick: function(e, cell){
                        const row = cell.getRow().getData();
                        showConfigPopup(row, e);
                    }
                }
            ]
        });
    }

    function updatePositionsTable() {
        positionsData = Object.values(positionsMap);
        tabulatorTable.replaceData(positionsData);
    }

    function showConfigPopup(row, event) {
        const popup = document.getElementById("configPopup");
        popup.style.top = `${event.clientY}px`;
        popup.style.left = `${event.clientX}px`;
        popup.style.display = "block";

        document.getElementById("cfgSymbol").value = row.symbol;
        fetch(`/config/${row.symbol}`, { headers: {"Authorization": "Bearer " + jwt}})
            .then(res => res.json())
            .then(data => {
                document.getElementById("cfgStopLoss").value = data.stop_loss ?? "";
                document.getElementById("cfgTrailingStop").value = data.trailing_stop ?? "";
                document.getElementById("cfgStrategy").value = data.strategy_on_stop_loss;
                document.getElementById("cfgReverse").value = data.reverse_on_trailing_stop;
            });
    }

    function closeConfig(){ document.getElementById("configPopup").style.display = "none"; }

    function toggleDefaultConfig(){ showConfigPopup({symbol: "default"}, {clientX: 300, clientY: 150}); }

    function saveConfig() {
        const symbol = document.getElementById("cfgSymbol").value || "default";
        const body = {
            stop_loss: parseFloat(document.getElementById("cfgStopLoss").value),
            trailing_stop: parseFloat(document.getElementById("cfgTrailingStop").value),
            strategy_on_stop_loss: document.getElementById("cfgStrategy").value,
            reverse_on_trailing_stop: document.getElementById("cfgReverse").value,
        };
        fetch(`/config/${symbol}`, {
            method: "POST",
            headers: {"Content-Type": "application/json", "Authorization": "Bearer " + jwt},
            body: JSON.stringify(body)
        }).then(res => res.json())
          .then(data => { alert(data.message || "Config saved"); closeConfig(); })
          .catch(err => alert("Error: " + err));
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        ws = new WebSocket(`${protocol}://${window.location.host}/ws/${decoded.sub}`);
        ws.onopen = () => wsStatus("lime", "connected");
        ws.onclose = () => { wsStatus("red", "disconnected"); setTimeout(connectWebSocket, 2000); };
        ws.onerror = (e) => { console.error(e); ws.close(); };
        ws.onmessage = (event) => {
            document.getElementById("wsLog").textContent += event.data + "\n";
            document.getElementById("wsLog").scrollTop = document.getElementById("wsLog").scrollHeight;
            try {
                const data = JSON.parse(event.data);
                const key = `${data.symbol}_${data.position_side?.toUpperCase()||""}`;
                positionsMap[key] = data;
                updatePositionsTable();
            } catch (e) {}
        };
    }

    function loadDefaultConfig() {
        fetch(`/config/default`, { headers: {"Authorization": "Bearer " + jwt}})
            .then(res => res.json())
            .then(data => {
                document.getElementById("cfgStopLoss").value = data.stop_loss ?? "";
                document.getElementById("cfgTrailingStop").value = data.trailing_stop ?? "";
                document.getElementById("cfgStrategy").value = data.strategy_on_stop_loss;
                document.getElementById("cfgReverse").value = data.reverse_on_trailing_stop;
            }).catch(()=>{});
    }

    async function saveKeys(e) {
        e.preventDefault();
        const res = await fetch("/api-keys", {
            method: "POST",
            headers: {"Content-Type": "application/json", "Authorization": "Bearer " + jwt},
            body: JSON.stringify({
                api_key: document.getElementById("apiKey").value,
                secret_key: document.getElementById("apiSecret").value
            })
        });
        alert(res.ok ? "Keys saved!" : "Error saving keys");
    }

    async function deleteKeys() {
        const res = await fetch("/api-keys", {
            method: "DELETE",
            headers: {"Authorization": "Bearer " + jwt}
        });
        if (res.ok) {
            document.getElementById("apiKey").value = "";
            document.getElementById("apiSecret").value = "";
            alert("Keys deleted!");
        } else alert("Error deleting keys");
    }

    function logout() { localStorage.removeItem("jwt"); location.href = "/"; }
    async function start() {
        const res = await fetch("/start-container", { method: "POST", headers: {"Authorization": "Bearer " + jwt} });
        alert((await res.json()).message || "Error starting container");
    }
    async function stop() {
        const res = await fetch("/stop-container", { method: "POST", headers: {"Authorization": "Bearer " + jwt} });
        alert((await res.json()).message || "Error stopping container");
    }

    document.getElementById("apiForm").addEventListener("submit", saveKeys);
    </script>
</body>
</html>
